import { readdirSync, readFileSync, writeFileSync } from 'fs';
import path from 'path';

const repoRoot = new URL('..', import.meta.url).pathname;
const migrationsDir = path.join(repoRoot, 'supabase', 'migrations');
const sqlDir = path.join(repoRoot, 'sql');
const outputFile = path.join(sqlDir, 'manual.sql');

const IGNORED_FILES = new Set(['demo_data.sql']);

function getMigrations() {
  return readdirSync(migrationsDir)
    .filter((file) => file.endsWith('.sql'))
    .filter((file) => !IGNORED_FILES.has(file))
    .sort();
}

function buildBundle(migrations) {
  const header = `-- Auto-generated manual bundle\n-- Source: supabase/migrations/*.sql\n-- Do not edit this file by hand.\n-- Last generated: ${new Date().toISOString()}\n`;
  const body = migrations
    .map((file) => {
      const sql = readFileSync(path.join(migrationsDir, file), 'utf8').trim();
      return [`-- === BEGIN MIGRATION: ${file} ===`, sql, `-- === END MIGRATION: ${file} ===`].join('\n');
    })
    .join('\n\n');
  return `${header}\n${body}\n`;
}

function main() {
  const migrations = getMigrations();
  if (migrations.length === 0) {
    throw new Error('No migrations found to bundle.');
  }

  const bundle = buildBundle(migrations);
  writeFileSync(outputFile, bundle, 'utf8');
  console.log(`Wrote ${outputFile} with ${migrations.length} migrations.`);
}

main();
